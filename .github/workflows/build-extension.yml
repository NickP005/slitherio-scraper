name: Build and Release Extension

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-extension:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd extension
        npm install
        
    - name: Build extension
      run: |
        cd extension
        npm run build
        
    - name: Create extension package
      run: |
        cd extension
        zip -r ../slither-esn-extension-${{ github.sha }}.zip . -x "node_modules/*" "src/*" "*.md" "package*.json"
        
    - name: Upload extension artifact
      uses: actions/upload-artifact@v4
      with:
        name: slither-esn-extension
        path: slither-esn-extension-*.zip
        
  release:
    needs: build-extension
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download extension artifact
      uses: actions/download-artifact@v4
      with:
        name: slither-esn-extension
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: "Slither.io ESN Data Collector ${{ steps.get_version.outputs.VERSION }}"
        body: |
          ## Slither.io ESN Data Collector Extension
          
          ### Installation Instructions
          1. Download the `slither-esn-extension.zip` file
          2. Extract the ZIP file
          3. Open Chrome/Edge and go to `chrome://extensions/`
          4. Enable "Developer mode"
          5. Click "Load unpacked" and select the extracted folder
          
          ### Features
          - Real-time data collection from Slither.io
          - Easy configuration via extension popup
          - Live statistics and connection status
          - Automatic data transmission to your backend server
          
          ### Usage
          1. Configure your username and server host in the extension popup
          2. Go to slither.io and start playing
          3. Data collection will begin automatically
          
          For detailed setup instructions, see the README.
        files: slither-esn-extension-*.zip
        draft: false
        prerelease: false